name: Check Template Dependencies

on:
  schedule:
    # Run every Saturday at 10:00 AM Chile time (after dependabot)
    - cron: '0 13 * * 6'
  workflow_dispatch: # Allow manual trigger

jobs:
  check-template-deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Check for outdated template dependencies
        id: check-deps
        run: |
          echo "## Template Dependencies Check" > deps-report.md
          echo "" >> deps-report.md
          echo "Checking \`src/templates/base/package.template.json\` for outdated dependencies..." >> deps-report.md
          echo "" >> deps-report.md

          # Read template package.json and extract dependencies
          TEMPLATE_FILE="src/templates/base/package.template.json"
          
          if [ ! -f "$TEMPLATE_FILE" ]; then
            echo "Template file not found!"
            exit 1
          fi

          # Create a temporary package.json to check versions
          mkdir -p /tmp/template-check
          
          # Extract dependencies (removing template variables)
          cat "$TEMPLATE_FILE" | sed 's/{{PROJECT_NAME}}/template-check/g' > /tmp/template-check/package.json
          
          cd /tmp/template-check
          
          # Install dependencies silently
          npm install --silent 2>/dev/null || true
          
          # Check for outdated packages
          OUTDATED_RAW=$(npm outdated --json 2>/dev/null || echo "{}")
          
          cd -
          
          # Filter updates: only where current != wanted (respects semver ranges)
          # This avoids suggesting major version jumps like @types/node@25 when using ^22.x
          SEMVER_UPDATES=$(echo "$OUTDATED_RAW" | jq 'to_entries | map(select(.value.current != .value.wanted)) | from_entries')
          
          # Separate major version updates (latest major > current major) for informational purposes
          MAJOR_UPDATES=$(echo "$OUTDATED_RAW" | jq '
            to_entries 
            | map(select(
                (.value.current | split(".")[0] | tonumber) < (.value.latest | split(".")[0] | tonumber)
              ))
            | from_entries
          ')
          
          HAS_SEMVER_UPDATES=false
          HAS_MAJOR_UPDATES=false
          
          if [ "$SEMVER_UPDATES" != "{}" ]; then
            HAS_SEMVER_UPDATES=true
          fi
          
          if [ "$MAJOR_UPDATES" != "{}" ]; then
            HAS_MAJOR_UPDATES=true
          fi
          
          if [ "$HAS_SEMVER_UPDATES" = "false" ] && [ "$HAS_MAJOR_UPDATES" = "false" ]; then
            echo "âœ… All template dependencies are up to date!" >> deps-report.md
            echo "has_updates=false" >> $GITHUB_OUTPUT
          else
            if [ "$HAS_SEMVER_UPDATES" = "true" ]; then
              echo "### âš ï¸ Updates available (within semver range)" >> deps-report.md
              echo "" >> deps-report.md
              echo "These updates are safe to apply and respect the current version constraints:" >> deps-report.md
              echo "" >> deps-report.md
              echo "\`\`\`json" >> deps-report.md
              echo "$SEMVER_UPDATES" | jq '.' >> deps-report.md
              echo "\`\`\`" >> deps-report.md
              echo "" >> deps-report.md
            fi
            
            if [ "$HAS_MAJOR_UPDATES" = "true" ]; then
              echo "### ðŸ“¦ Major version updates available (informational)" >> deps-report.md
              echo "" >> deps-report.md
              echo "> **Note:** These are major version bumps that may contain breaking changes." >> deps-report.md
              echo "> Review changelogs before updating. For \`@types/node\`, the major version should match your target Node.js version." >> deps-report.md
              echo "" >> deps-report.md
              echo "\`\`\`json" >> deps-report.md
              echo "$MAJOR_UPDATES" | jq '.' >> deps-report.md
              echo "\`\`\`" >> deps-report.md
              echo "" >> deps-report.md
            fi
            
            echo "### Suggested Actions" >> deps-report.md
            echo "" >> deps-report.md
            if [ "$HAS_SEMVER_UPDATES" = "true" ]; then
              echo "- Update \`src/templates/base/package.template.json\` with the semver-compatible versions above." >> deps-report.md
            fi
            if [ "$HAS_MAJOR_UPDATES" = "true" ]; then
              echo "- Review major updates and decide if bumping to new major versions is appropriate for the template." >> deps-report.md
            fi
            
            # Only create issue if there are actual semver updates (not just major version info)
            if [ "$HAS_SEMVER_UPDATES" = "true" ]; then
              echo "has_updates=true" >> $GITHUB_OUTPUT
            else
              echo "has_updates=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          cat deps-report.md

      - name: Create issue if updates available
        if: steps.check-deps.outputs.has_updates == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('deps-report.md', 'utf8');
            
            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'template-deps'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ“¦ Template dependencies need updating',
                body: report,
                labels: ['template-deps', 'dependencies']
              });
              console.log('Created new issue for template dependencies');
            } else {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: report
              });
              console.log('Updated existing issue');
            }
